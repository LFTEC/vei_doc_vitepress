# 概述
为践行万华物装部业务发展战略，实现采购业务执行的智能化和自动化水平，公司上线了供应商生态库存（VEI）2.0 项目。通过该项目的加持，万华物资采购业务将实现与不限量供应商的库存共享业务，并充分利用供应商的备货库存，实现供应商端的平衡利库，优化采购策略，达到互利共赢。

# 接入方式
因供应商对接能力的不同，项目实现了两种对接方式：联机版和单机版。

联机版将万华系统与供应商系统进行对接，实现系统层面的库存共享。万华的需求、供应商库存的变化将第一时间通过系统对接实现数据的传递，减少人工的干预。万华的采购需求也将第一时间发送给供应商，供应商可以有更长的备货周期，确保及时、准确交货。详情请参考[联机版](#联机版)。

单机版适合没有独立系统或 IT 能力不强、系统对接意愿不强的供应商。通过人工周期性的将库存传递给万华。万华的采购需求仍通过线下进行传递。详情请参考[单机版](offline)。

## 联机版与单机版的比较
|     | 联机版 | 单机版 | 备注 |
| :--- | :---: | :---: | :--- |
| 库存共享 | &#9989; | &#9989; |  |
| 平衡利库 | &#9989; | &#9989; | 联机版与单机版享有完全相同的优先级。系统并不会优先使用联机版供应商的库存进行采购。 |
| 锁定通知 | &#9989; | ❌ | 锁定通知是指万华的采购需求由该供应商满足时，第一时间发出的通知。该通知会提前两到三天通知到供应商，以便有更充裕的送货时间 |
| 下单通知 | &#9989; | &#9989; | 当采购员下达采购订单时，无论联机版还是单机版都会收到一封电子邮件通知 |
| 准确性 | 高 | 略低 | 联机版供应商可实时将备库数据变化同步给万华，万华系统亦可根据该数据分析备货周期。单机版供应商则每隔数日进行同步 |
| 效率 | 高 | 低 | 联机版完全由双方系统自动执行，单机版则必须由人员线下整理数据进行上传 |
| 对接难度 | 高 | 低 | 联机版需一定的开发工作。单机版则是下载安装即用 |



# 平库逻辑
为实现公平公正的需求分配逻辑，实现每个供应商都能合理的获取到采购订单，系统设计了一套完善的平库逻辑。万华的系统将严格的运行在该逻辑之下。如果您对单据分配有任何的异议，请先参考此部分内容，然后再与我们进行沟通。

<mark>阅读这部分内容之前，请首先仔细阅读业务指南部分。详细了解万华 VEI 业务的运行逻辑。此部分仅展示系统在需求分配时的执行逻辑。</mark>


## 平库的优先级
当有物资需求产生时，系统将严格按下面的优先级进行满足。
1. **万华自有库存**
当有物资需求产生时，使用万华内部的物资库存进行满足是第一优先级。我们必须首先利用自己已有的库存，这些库存包括但不限于工厂内自有库存，物资公司库存，异地库存，呆滞库存等。仅当万华没有库存或库存无法满足使用条件时，才会进行外部采购。
2. **VEI 供应商库存**
当万华自有库存无法满足需求时，我们会优先使用与我们进行生态库存对接的供应商进行采购。并且我们确保在 VEI 供应商的供货能力内应用尽用。
3. **框架供应商采购**
当自有库存和 VEI 供应商均无法满足需求时，我们会使用与万华签订了框架合同的供应商进行采购。
4. **招采流程**
如果物资上述条件均无法满足时，将启动招投标或询比价流程，寻找合适的供应商进行合作。

## VEI分配逻辑
万华系统中，需求分配给 VEI 供应商的逻辑是一套复杂的功能，该功能的算法核心是混合整数规划模型（MIP）。该模型的思想是通过对各种参数的分析，计算所有分配组合的价值，从而计算出最大价值的那一套分配结果作为最终分配结果。万华系统使用 Google 的 OR-Tools 开源工具作为该计算模型的算法支撑。OR-Tools 文档请参考[此网站](https://developers.google.com/optimization?hl=zh-cn)。

<mark>联机版 VEI 供应商与单机版 VEI 供应商在分配逻辑上没有任何差别</mark>

### 配额计算
供应商对应物资的配额不是固定的，而是每次需求分配时，系统根据配额计算公式进行计算获得。系统在每次需求分配时，会将所有能够供货的供应商一起进行计算。首先计算每家供应商的配额得分，然后汇总计算每家供应商的配额。计算公式如下：

$$
\begin{gathered}
设A_i 为第 i 家供应商的配额得分 \\
A_i = \frac{A_i}{\sum_{i=1}^n{A_i}} \times 100\%
\end{gathered}
$$

每家供应商的配额得分，则是通过下面四个维度进行计算
* [备货数量维度](#备货数量)
* [框架价格维度](#框架价格)
* [考核得分维度](#考核得分)
* [VEI 评价得分维度](#vei评价得分)

同时，采购员会针对每个物料品类维护上面 4 个维度在计算时的权重值（4 个维度的权重值之和为 100）。最终配额得分公式如下：

$$
\begin{aligned}
& 设：备货数量得分为Q，权重为 Q_W\\
& 框架价格得分为 P，权重为 P_W \\
& 考核得分为 K，权重为 K_W \\
& \text{VEI 评价得分为} E，权重为 E_W \\
& 则\quad A = \frac{Q \cdot Q_W + P \cdot P_W + K \cdot K_W + E \cdot E_W }{Q_W + P_W + K_W + E_W} \times 100\%
\end{aligned}
$$

#### 备货数量
备货数量得分根据采购员维护的[期望备货中位数](#bhzw_1)，以及供应商当前的备货数量一起进行计算获得。满分为 10 分，最低 0 分。公式如下：

$$
Q = \frac{V_{qty}}{m + V_{qty}} \times 10
$$


#### 框架价格
框架价格得分根据该物料所有供货供应商中，最低价格与该供应商价格的比值进行计算。 满分为 10 分，最低 0 分。

$$
P = \frac{p_{min}}{p} \times 10
$$

#### 考核得分
每年万华会对所有供应商进行考核，考核得分为 $k \in [0, 100]$。 如果供应商去年没有考核得分，则为 50 分。

$$
K = k\ /\ 10
$$
#### VEI评价得分
VEI 供应商每月会计算一个评价得分，次月重新计算。评价得分 $e \in [0,100]$。如果供应商上月没有评价得分，则默认为 100 分

$$
E = e\ /\ 10
$$

##### VEI评价得分计算逻辑
当万华向 VEI 供应商下单时，会约定一个**最迟交货日期**。该日期根据需求日期与物料品类的设定交货周期及运输周期有关。

当系统进行需求分配时，首先计算供应商预计交货日期，该日期为$处理日期 + 品类设定交货周期 + 运输周期$。
* **处理日期**：系统分配需求给供应商所在的日期
* **品类交货期**： 采购员设置的品类交货期
* **运输周期**：如果供应商与需求所在地为同省，则为 1 天；跨省则为 3 天

如果需求日期超过供应商预计交货日期，则以需求日期作为最迟交货日期，否则以供应商预计交货日期为最迟交货日期。

如果供应商未在指定的最迟交货日期前进行交货，则进行对应的扣分。VEI 评价得分只会扣分不会加分，每月初始值为 100 分。

扣分分值的暂定逻辑如下：延迟一到三天，每天 0.01分。延迟超过三天小于六天的，每天 0.02 分。延迟第六天扣除0.03 分。延迟在第七天和第八天每天0.05 分。第九天0.1 分。超过十天（包括十天）的，每天扣除0.2 分。

<mark>如果系统分配需求给供应商后，因供应商原因无法交货的，采购员会撤销该次分配。此时每项扣除 0.1 分</mark>

### 差额计算
在计算好每个供应商对应每个物料的配额后。系统会计算该物料本月在供应商出已经锁定或下单的数量合计，并计算出供应商已分配数量的比例。则差额比例为配额比例减已分配比例的差。

### 供应商优先级
VEI 供应商包括两个种类：
* **框架 VEI 供应商**：这种类型的供应商与万华签署了 VEI 合作框架协议，我们将优先使用这种类型供应商进行分配
* **价格合理性供应商**：该类型的供应商未与万华签订框架协议，但是愿意按框架供应商约定的条件进行供货。这种类型供应商的优先级低于框架供应商。

### 供应商能力等级
当产生采购员认为供货期比较紧急的需求，系统会选取有能力的供应商来满足需求。供应商能力等级的计算请参考[期望交货日期](#期望交货日期)

#### 期望交货日期
在下单给供应商时，除了会告知供应商最迟交货日期外，也会同时给供应商一个期望交货日期。该交货日期即为采购需求的需求日期。  
系统会分析每次供应商的交货，当交货日期都早于期望交货日期时，会认定供应商的能力较强。如果出现无法按期望日期交货的情况，则会调低供应商的能力预期。

### 可用库存
供应商通过联机版或单机版系统传输的库存，系统会计算其中可用库存的部分，计算逻辑如下：
* 针对单机版，如果自上次传入库存至今的间隔超过采购员指定天数，则可用库存值为零。
* 除上面的情况外，可用库存数量 = 供应商上传备货数量 - 锁定数量

#### 锁定数量
锁定数量是系统将需求分配给供应商，但采购人员还未走完下单流程的单据数量。当采购人员完成下单流程，则系统会同时减掉对应的供应商备库数量和锁定数量。如果采购员撤回该笔业务，则锁定数量相应扣减。

举例说明：  
1. 设供应商备库数量为 10 ，系统分配 2 个需求给供应商，此时供应商锁定数量为 2，可用库存为 8。如果采购员完成下单操作，则供应商备库数量调减为 8 个，锁定数量为 0，可用库存为 8。
2. 设供应商备库数量为 10，锁定数量为 2，可用数量为 8。当采购员撤销2 个下单业务时，备库数量仍为 10，锁定数量减为 0，可用数量为 10。

### 分配计算逻辑
如上所述，当系统进行 VEI 库存分配时，使用 MIP 混合整数规划模型进行计算。该计算将考虑如下几个方面：
1. 需求数量尽量都由 VEI 供应商满足，除非供应商无法满足；
2. 单次提报的需求，同品类物资尽量由一家供应商满足；
3. 对于紧急的需求，尽量交给能力强的供应商进行满足；
4. 优先使用框架 VEI 供应商，然后再是价格合理性供应商；
5. 分析分配差异，优先将需求给分配差异大的供应商；

以上 5 个要求并没有固定的优先级，而是按照采购员设定的参数来进行调整。参数主要包括：[MIP 数量权重](#mip-q)，[MIP 单一供应商权重](#mip-v)，[MIP 差额权重](#mip-o)。

当一次需求分配时，系统会将该次需求的所有物料统一进行规划考虑。

### 名词解释
* **分配相关**
  * 配额比例：每个供应商在每个物资上应该分配的比例，请参考[配额计算]()
  * 差额比例：供应商在该物料上实际分配的比例与配额之间的差异。<span id="offset" />
* **需求相关**
  * 需求紧急度（难度）：需求紧急度表示一个需求根据需求日期计算的紧急程度。我们为每个物资种类分配了一个合理的供货周期。需求时间越早，则紧急度越高。
* **供应商相关**
  * 备货数量：供应商为该物资准备的备货数量
  * 框架价格：供应商与万华签订的框架合同中，该物资的基础价格
  * 考核得分：供应商每年的绩效得分
  * VEI 评价得分：供应商在 VEI 订单上的每一次供货信息都将进行评价，以计算考核打分。该分值每个月清零重新记分。请参考[VEI 评价得分]()
* **计算参数相关**：我们为每一个物料品类分配模型计算的参数，这些参数会影响实际的分配比例
  * 备货数量权重：供应商备货的数量在配额计算中的权重
  * 价格权重：供应商框架合同的价格在配额计算中的权重
  * 考核得分权重：供应商绩效考核在配额计算中的权重
  * VEI 评价得分权重：供应商 VEI 评价得分在配额计算中的权重
  * MIP 数量权重：规划模型中，分配数量的重要性，同时也会影响紧急预留高能力供应商的分配及供应商优先级的分配<span id="mip-q" />
  * MIP 单一供应商权重：该类物资是否尽量由单一供应商供货的比重。单一供应商供货是指，在一次需求提报中，同一类的物资是否尽量由一家供应商满足。 <span id="mip-v" />
  * MIP 差额权重：规划模型对该供应商差额比例的重视程度。该程度越高，那么供应商的配额与实际分配的差异就越会被规划模型重视。也就是说模型会选择去将供应商的[差额比例](#offset)尽量抹平 <span id="mip-o" />
  * 期望备货中位数：万华对该类物资备货数量认可的及格线，该参数用于计算[备货数量得分](#备货数量)<span id="bhzw_1"/>

